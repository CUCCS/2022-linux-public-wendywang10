# H5 shell脚本编程基础实验
## 实验环境
- Ubuntu20.04
- Nginx
- VeryNginx
- WordCompress
- - -
## 实验要求

### 基本要求
- 在一台主机（虚拟机）上同时配置Nginx和VeryNginx
- - VeryNginx作为本次实验的Web App的反向代理服务器和WAF
- - PHP-FPM进程的反向代理配置在nginx服务器上，VeryNginx服务器不直接配置Web站点服务
- 使用Wordpress搭建的站点对外提供访问的地址为： http://wp.sec.cuc.edu.cn
- 使用Damn Vulnerable Web Application (DVWA)搭建的站点对外提供访问的地址为： http://dvwa.sec.cuc.edu.cn
（自测仅完成了基本要求....)
- --
### 安全加固要求
- 使用IP地址方式均无法访问上述任意站点，并向访客展示自定义的友好错误提示信息页面-1
- Damn Vulnerable Web Application (DVWA)只允许白名单上的访客来源IP，其他来源的IP访问均向访客展示自定义的友好错误提示信息页面-2
- 在不升级Wordpress版本的情况下，通过定制VeryNginx的访问控制策略规则，热修复WordPress < 4.7.1 - Username Enumeration
- 通过配置VeryNginx的Filter规则实现对Damn Vulnerable Web Application (DVWA)的SQL注入实验在低安全等级条件下进行防护
- --
### VeryNginx配置要求
- VeryNginx的Web管理页面仅允许白名单上的访客来源IP，其他来源的IP访问均向访客展示自定义的友好错误提示信息页面-3
- 通过定制VeryNginx的访问控制策略规则实现：
- - 限制DVWA站点的单IP访问速率为每秒请求数 < 50
- - 限制Wordpress站点的单IP访问速率为每秒请求数 < 20
- - 超过访问频率限制的请求直接返回自定义错误提示信息页面-4
- - 禁止curl访问
- - -
## 实验过程
### 环境准备
#### 1.更改Windows主机hosts文件(注意这里需要管理员权限！)
```
192.168.56.101 vn.sec.cuc.edu.cn
192.168.56.101 dvwa.sec.cuc.edu.cn
192.168.56.101 wp.sec.cuc.edu.cn
```
#### 2.安装php及相关组件和mysql:

```
sudo apt install php-fpm php-mysql php-curl php-gd php-intl php-mbstring php-soap php-xml php-xmlrpc php-zip
sudo apt -y install mysql-server
```
### 基本要求
#### 1.安装Nginx
```
#安装
sudo apt update && sudo apt install nginx

#nginx安装完成并查看版本
nginx -V
![查看版本与安装nginx](/img/查看版本与安装nginx.png)
#验证是否安装成功
sudo nginx -t
```
![验证nginx](/img/验证nginx.png)
#### 2.安装VeryNginx
```
#安装git
sudo apt install git

#克隆VeryNginx仓库到Linux，下载verynginx安装包
git clone https://github.com/alexazhou/VeryNginx.git
![git clone](/img/git clone.png)
#安装相关依赖包
sudo apt-get install libssl-dev
sudo apt install libpcre3 libpcre3-dev
sudo apt install build-essential
sudo apt install zlib1g-dev
sudo apt install gcc
sudo apt install make
sudo python3 install.py install
```
![安装VeryNginx](/img/安装VeryNginx.png)
#### 3.修改配置文件
```
sudo vim /opt/verynginx/openresty/nginx/conf/nginx.conf
```
![修改配置](/img/修改配置.png)
```
#添加进程权限
sudo chmod -R 777 /opt/verynginx/verynginx/configs

#建立软连接
sudo ln -s /opt/VeryNginx/openresty/nginx/sbin/nginx /usr/sbin/verynginx
```
#### 4.启动nginx和verynginx
```
#启动nginx服务
sudo nginx
```
![启动nginx](/img/启动nginx.png)
```
#启动verynginx服务
sudo /opt/verynginx/openresty/nginx/sbin/nginx
```
#### 5.连接端口
访问`192.168.56.102:8081/verynginx/index.html`
![访问页面](/img/访问.png)

#### 6.Wordpress
新建数据库用于Wordpress数据管理
```
#登录mysql
$ sudo mysql

#创建wordpress数据库
CREATE DATABASE wordpress DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci;

# 创建cuc用户
create user 'cuc'@'localhost' identified by 'cuc';

# 给用户授权
grant all on wordpress.* to 'cuc'@'localhost';

# 退出
exit
```
![mysql](/img/mysql.png)

#### 7.PHP-FPM进程的反向代理配置在nginx服务器上
```
#复制文件
sudo cp /etc/nginx/sites-available/default /etc/nginx/sites-available/wp.sec.cuc.edu.cn

#语法检查
sudo nginx -t

#修改nginx配置文件
$ sudo vim /etc/nginx/sites-enabled/default
     #将下列内容取消注释
     location ~ \.php$ {
            include snippets/fastcgi-php.conf;
            fastcgi_pass unix:/var/run/php/php7.2-fpm.sock;
     }
```
![取消注释](/img/取消注释.png)
```
#重新启动nginx
sudo systemctl restart nginx

#一些其他拓展
sudo apt update
sudo apt install php-curl php-gd php-intl php-mbstring php-soap php-xml php-xmlrpc php-zip
```
#### 8.DVWA
安装过程：
```
# 下载
git clone https://github.com/digininja/DVWA.git
# 建立目录
sudo mkdir /var/www/html/dvwa.sec.cuc.edu.cn
# 把下载好的DVWA移到刚刚创建的目录下
sudo mv DVWA/* /var/www/html/dvwa.sec.cuc.edu.cn

# 修改文件夹属主为 www-data
sudo chown -R www-data:www-data /var/www/html/dvwa.sec.cuc.edu.cn
```
配置MySQL：
```
# 启动MySQL
sudo mysql
# 建立dvwa的数据库
CREATE DATABASE dvwa DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci;
# 创建用户
CREATE USER 'dvwa'@'localhost' IDENTIFIED BY 'cuc';
# 授权
GRANT ALL ON dvwa.* TO 'dvwa'@'localhost';
# 退出
exit
# 重启mysql使配置文件生效
sudo systemctl restart mysql
```
配置PHP：
```
# 将/var/www/html/dvwa.sec.cuc.edu.cn/config/目录下的config.inc.php.dist文件改名为config.inc.php
cd /var/www/html/dvwa.sec.cuc.edu.cn/config/
sudo mv config.inc.php.dist config.inc.php

# 默认配置：
$_DVWA[ 'db_database' ] = 'dvwa';
$_DVWA[ 'db_user' ] = 'dvwa';
$_DVWA[ 'db_password' ] = 'cuc';

# 修改php-fpm文件
sudo vim /etc/php/7.4/fpm/php.ini 

allow_url_include: On

#重启php
systemctl restart php7.4-fpm.service

#授权给www-data用户和组
sudo chown -R www-data.www-data /var/www/html/dvwa.sec.cuc.edu.cn
```
配置服务器块文件:
```
sudo vim /etc/nginx/sites-available/dvwa.sec.cuc.edu.cn

# 写入配置文件
server {
    listen 8080 default_server;
    listen [::]:8080 default_server;

    root /var/www/html/dvwa.sec.cuc.edu.cn;
    index index.php index.html index.htm index.nginx-debian.html;
    server_name dvwa.sec.cuc.edu.cn;

    location / {
        #try_files $uri $uri/ =404;
        try_files $uri $uri/ /index.php$is_args$args;  
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
    }

    location ~ /\.ht {
        deny all;
    }
}

# 创建软链接
sudo ln -s /etc/nginx/sites-available/dvwa.sec.cuc.edu.cn /etc/nginx/sites-enabled/

# 检查并重启服务
sudo nginx -t
systemctl restart nginx.service
```
![DVWA](/img/DVWA.png)
用户名：dvwa 密码：cuc
-- -
## 遇到的问题与解决方案
1.关于host文件无法更改
需要“windows+X”打开管理员权限，打开host更改（详见参考文件）
2.验证是否安装成功nginx这一点，一开始我看到有同学提及觉得不以为意，最后发现非常重要！下载过程中如果y与Y输入的错误都可能导致下载中断，验证是否安装成功是非常重要的一个步骤！
3.虚拟机无法实现clone，可以考虑用git bash免密登录实现clone
（因为经常远程连接用着用着就出问题了，所以截图各个程序切换真是不好意思...)
- --
## 参考
[如何更改host文件](https://jingyan.baidu.com/article/335530dafcb63719cb41c3ad.html)
[同学的仓库](https://github.com/CUCCS/2022-linux-public-MengQiurong/tree/H5)
[同学的仓库](https://github.com/CUCCS/2022-linux-public-dangyuyan/blob/chap0x05/chap0x05/chap0x05.md)
因为做的比较晚所以有幸看到了做得早的同学的智慧结晶，他们的很多参考文献都对我提供了非常大的帮助。